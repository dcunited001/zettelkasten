:PROPERTIES:
:ID:       e2ab84be-ecc1-4556-b23e-a074ba0b8f10
:END:
#+TITLE: Emacs: Learning GNUS
#+CATEGORY: slips
#+TAGS:

* Roam
+ [[id:6f769bd4-6f54-4da7-a329-8cf5226128c9][Emacs]]
+ [[id:286b6d1b-362b-44fe-bb19-e0e78513d615][GNU]]
+ [[id:8fb0a586-9c0f-4f36-b1ab-dc5c26681d15][OSS]]

* Resources

+ [[https://github.com/redguardtoo/mastering-emacs-in-one-year-guide/blob/master/gnus-guide-en.org][gnus]] in [[github:redguardtoo/mastering-emacs-in-one-year-guide][redguardtoo/mastering-emacs-in-one-year-guide]]

** Configs

*** [[https://github.com/dickmao/gnus-imap-walkthrough/blob/master/dot.emacs][dickmao/gnus-imap-walkthrough]]

A fairly complete split-imap configuration featuring multiple IMAP accounts,
dovecot/mbsync, and setup scripts -- along with CI scripts for testing.

** Videos

*** [[https://www.youtube.com/watch?v=hbCXqDT1iNI][How to set up Gnus in Emacs for GMAIL in a seven minutes]]

Quick overview on configuring GNUS.

*** [[https://www.youtube.com/watch?v=jwz7aYUWIbM][Emacs: Introduction to GNUS]]

Video from Prot on GNUS. See also [[https://github.com/protesilaos/dotfiles/blob/master/emacs/.emacs.d/prot-emacs-modules/prot-emacs-gnus.el][prot-emacs-gnus.el]]

*** [[https://emacsconf.org/2022/talks/mail/][Revisiting the anatomy of Emacs mail user agents]]

Interesting presentation on holistic design of Email applications at a general
level. Compares/contrasts the architecture of email applications but also covers
specific architectural patterns seen in Emacs & open source.

Some great flow-charts here on split-IMAP email configurations for Emacs that
I'm imagining are a bit hard-to-find elsewhere. Also on [[https://www.youtube.com/watch?v=dJXBUlbxU3E][youtube]].

* Workflows

I have multiple computers from which I may use emacs. i believe I will use GNUS
mostly from one laptop, but this laptop needs work.

** Quitting Gnus

** Syncing Data

There is the [[https://www.gnu.org/software/emacs/manual/html_mono/gnus.html#The-Gnus-Cloud][Gnus Cloud package]] with four variables. The docs describe it best.

From the group buffer: =~ d= to download and =~ u= to upload

+ The EPG integration (Emacs GPG integration) is transparent, which is
  configured in =gnus-cloud-storage-method=.
+ To sync the data, it calls =gnus-cloud-encode-data= and eventually
  =epg-encrypt-string=. For it to do so, =(gpg-make-context 'OpenPGP)= will need
  to successfully create a context representing your GPG configuration. It
  should be able to read most of what it needs via =gpgconf=.
+ Since it uses =epg-encrypt-string= with symmetric encryption for the content,
  I don't know of any way to precache the file's password into GPG. unless GPG
  will try a generic cached password (which it may). This means that to encrypt
  the backup for the first time, you must have =(setq epg-pinentry-mode
  'loopback)= or the encryption will fail. This is the most convenient option
  for this variable anyways.

** Merging GNUS state

*** Recovering Group Subscriptions

Read the [[https://www.gnu.org/software/emacs/manual/html_mono/gnus.html#Startup-Files][Startup Files]] section in the manual. You should be able to import the
=.newsrc= file and run

* GNUS Data

Since GNUS manages contains email related information, I want to be aware of
exactly what data is being stored where. To this end, I've "containerized" the
files that Gnus uses, to the extent possible and thus my paths are a bit
different.

Much of this information is in [[https://www.gnu.org/software/emacs/manual/html_mono/gnus.html#Choosing-a-Mail-Back-End][Choosing a Mail Back End]].

|-------------------+-----------------------------------------------------|
| Path              | Desc                                                |
|-------------------+-----------------------------------------------------|
| $HOME/.newsrc     | This file generates the =.newsrc.eld=               |
| $HOME/.newsrc.eld | This file contains metadata and session-based data. |
| $HOME/Mail        | Mail folders                                        |
| $HOME/News        | These are the                                       |
|-------------------+-----------------------------------------------------|

If you have =no-littering=,

** nnfolder ([[https://www.gnu.org/software/emacs/manual/html_mono/gnus.html#Mail-Folders][Mail Folders]])

These servers are backed by the file system and usually stored in =~/Mail= or
whatever =message-directory= is set to. This is stored in the =mbox= format.

* Notes


** Concepts

+ Un/Plugged :: Whether you're connected to the online source
+ Agent ::
+ Topics ::
+ Scores ::

** Modes

+ Server Mode
+ Browse Server Mode
+ Group Mode
+ Summary Mode
+ Article Mode

** Configuration

*** NNTP Server

- stores messages in gnus-directory =~/News=
- fetches from =$NNTPSERVER= or =/etc/nntpserver=
- caches state in =~/.newsrc=
- gnus-home-directory
  - gnus-startup-file
  - gnus-init-file
  - gnus-directory (set to SAVEDIR if defined)

*** Email

Before GNUS starts, you need to have the following configured:

+ You need =auth-sources= set up for =imap.gmail.com=
+ You have have such a method configured in =gnus-select-method= or
=gnus-secondary-select-method=

My config for this looks like:

#+begin_src emacs-lisp
(setq gnus-select-method '(nnimap "imap.gmail.com")
      gnus-secondary-select-methods '((nntp "news.gmane.io"))
      message-send-mail-hook #'smtpmail-send-it
      gnus-message-archive-group "\"Gmail]/Sent Mail\"")
#+end_src

*** Other

Some config values that seemed interesting useful at the time, mostly from an
embark buffer from when I found the best way to configure NNTP was with
=/etc/nntpserver=. You can tell I talk to a lot of people who use Emacs.

#+begin_src emacs-lisp
;; gnus-newsrc-alist
;; gnus-newsrc-hashtb
;; gnus-newsrc-options
;; gnus-newsrc-options-n
;; gnus-save-newsrc-hook
;; gnus-newsrc-file-version
;; gnus-read-newsrc-el-hook
;; gnus-save-quick-newsrc-hook
;; gnus-newsrc-last-checked-date
;; gnus-save-standard-newsrc-hook
;; gnus-save-newsrc-file-last-timestamp
#+end_src


** Interface

*** Formatting

See [[https://www.gnu.org/software/emacs/manual/html_node/gnus/Formatting-Variables.html][formatting variables]]. Tables below contain stuff from embark, defaults.

See =M-x gnus-update-format= and =gnus-update-format-specifications=. Gnus
doesn't use the emacs =font-lock-mode=

The critical features. Variables with a =-format= usually have a =-alist= that
describes how the =-spec= is formed.

|--------------+-------------------+------------------------------------+---------------------------------------------------------------------|
| gnus-article | mode-line-format  | Gnus: %g %S%m                      | The format specification for the article mode line.                 |
| gnus-article | time-format       | %a, %d %b %Y %T %Z                 | Format for display of Date headers in article bodies.               |
|--------------+-------------------+------------------------------------+---------------------------------------------------------------------|
| gnus-group   | line-format       | %M%S%p%P%5y:%B%(%g%)\n             | Format of group lines.                                              |
| gnus-group   | mode-line-format  | Gnus: %%b {%M%:%S}                 | The format specification for the group mode line.                   |
|--------------+-------------------+------------------------------------+---------------------------------------------------------------------|
| gnus-server  | line-format       | {%(%h:%w%)} %s%a%c\n               | Format of server lines.                                             |
| gnus-server  | mode-line-format  | Gnus: %%b                          | The format specification for the server mode line.                  |
|--------------+-------------------+------------------------------------+---------------------------------------------------------------------|
| gnus-summary | dummy-line-format | %(:                                | The format specification for the dummy roots in the summary buffer. |
| gnus-summary | line-format       | %U%R%z%I%(%[%4L: %-23,23f%]%) %s\… | The format specification of the lines in the summary buffer.        |
| gnus-summary | mode-line-format  | Gnus: %g [%A] %Z                   | The format specification for the summary mode line.                 |
| gnus-summary | pick-line-format  | %-5P %U%R%z%I%(%[%4L: %-23,23n%]%… | The format specification of the lines in pick buffers.              |
|--------------+-------------------+------------------------------------+---------------------------------------------------------------------|

Misc

|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-category | line-format                     | %(%20c%): %g\n             | Format of category lines.                                       |
| gnus-category | mode-line-format                | Gnus: %%b                  | The format specification for the category mode line.            |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-cited    | closed-text-button-line-format  | %(%{[+]%}%)\n              | Format of closed cited text buttons.                            |
| gnus-cited    | opened-text-button-line-format  | %(%{[-]%}%)\n              | Format of opened cited text buttons.                            |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-diary    | summary-line-format             | %U%R%z %uD: %(%s%) (%ud)\n | Summary line format for nndiary groups.                         |
| gnus-diary    | time-format                     | %a, %b %e %y, %H:%M        | Time format to display appointments in nndiary summary buffers. |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-mime     | button-line-format              | %{%([%p. %d%T]%)%}%e\n     | Format of the MIME buttons.                                     |
| gnus-mime     | security-button-end-line-format | %{%([[End of %t]%D]%)%}\n  | The following specs can be used:                                |
| gnus-mime     | security-button-line-format     | %{%([[%t:%i]%D]%)%}\n      | The following specs can be used:                                |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-topic    | line-format                     | %i[ %(%{%n%}%) -- %A ]%v\n | Format of topic lines.                                          |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|
| gnus-tree     | line-format                     | %(%[%3,3n%]%)              | Format of tree elements.                                        |
| gnus-tree     | mode-line-format                | Gnus: %%b %S %Z            | The format specification for the tree mode line.                |
|---------------+---------------------------------+----------------------------+-----------------------------------------------------------------|

+ gnus-next-page-line-format: =%{%(Next page...%)%}\n=
+ gnus-prev-pageline-format: =%{%(Previous page...%)%}\n=


*** Windows and Buffers

**** gnus-buffer-configuration

From the [[https://www.gnu.org/software/emacs/manual/html_node/gnus/Window-Layout.html][manual]]

 | group               | vertical 1.0 | group 1.0 point        |                              |             |
 | summary             | vertical 1.0 | summary 1.0 point      |                              |             |
 | article (w/  trees) | vertical 1.0 | summary 0.25 point     | tree 0.25                    | article 1.0 |
 | article (w/o trees) | vertical 1.0 | summary 0.25 point     | article 1.0                  |             |
 | server              | vertical 1.0 | server 1.0 point       |                              |             |
 | browse              | vertical 1.0 | browse 1.0 point       |                              |             |
 | message             | vertical 1.0 | message 1.0 point      |                              |             |
 | pick                | vertical 1.0 | article 1.0 point      |                              |             |
 | info                | vertical 1.0 | info 1.0 point         |                              |             |
 | summary-faq         | vertical 1.0 | summary 0.25           | faq 1.0 point                |             |
 | only-article        | vertical 1.0 | article 1.0 point      |                              |             |
 | edit-article        | vertical 1.0 | article 1.0 point      |                              |             |
 | edit-form           | vertical 1.0 | group 0.5              | edit-form 1.0 point          |             |
 | edit-score          | vertical 1.0 | summary 0.25           | edit-score 1.0 point         |             |
 | edit-server         | vertical 1.0 | server 0.5             | edit-form 1.0 point          |             |
 | post                | vertical 1.0 | post 1.0 point         |                              |             |
 | reply               | vertical 1.0 | article 0.5            | message 1.0 point            |             |
 | forward             | vertical 1.0 | message 1.0 point      |                              |             |
 | reply-yank          | vertical 1.0 | message 1.0 point      |                              |             |
 | mail-bounce         | vertical 1.0 | article 0.5            | message 1.0 point            |             |
 | pipe                | vertical 1.0 | summary 0.25 point     | "*Shell Command Output*" 1.0 |             |
 | bug                 | vertical 1.0 | "*Gnus Bug*" 1.0 point |                              |             |
 | score-trace         | vertical 1.0 | summary 0.5 point      | "*Score Trace*" 1.0          |             |
 | score-words         | vertical 1.0 | summary 0.5 point      | "*Score Words*" 1.0          |             |
 | split-trace         | vertical 1.0 | summary 0.5 point      | "*Split Trace*" 1.0          |             |
 | category            | vertical 1.0 | category 1.0           |                              |             |
 | compose-bounce      | vertical 1.0 | article 0.5            | message 1.0 point            |             |
 | display-term        | vertical 1.0 | "*display*" 1.0        |                              |             |
 | mml-preview         | vertical 1.0 | message 0.5            | mml-preview 1.0 point        |             |

*** Links

**** Article Headers

header regexp button form callback par
* Commands

Most commands seem to be grouped in categories associated to capital
letters. The descriptions here are mostly generated from the refcard sections.

** Group

+ A :: List groups
+ G :: Create & Edit Groups
+ H :: Group Info
+ S :: Unsub, Yank and Kill
+ M :: Mark Groups
+ D :: Sieve Scripts
+ J :: Plug & Unplug
+ T :: Group Topics

** Summary

+ A :: Scroll, Fetch, Process/Translate
+ G :: Select Articles
+ T :: Threading
+ / :: Limit, Filter, Search
+ V :: Score & Value
+ O :: Output Articles
+ X :: Extract Series
+ K :: MIME Ops from Summary Buffer
+ W M :: Additional MIME/Decoding ops
+ S :: Post, Followup, Reply, FWD, Cancel
+ M :: Mark
+ M V :: Mark Based on Score
+ M P :: The Process Mark
+ C-c C-s :: Sort the summary Buffer
+ C-c C-f :: Jumping in the Message Buffer
+ C-c C-m :: Attachements/MML

** Article

+ W :: Wash commands
+ W E :: Blank lines and whitespace
+ W D :: Picons, X-Faces, Smileys
+ W T :: Time and Date
+ W W :: Hide parts of the article
+ W H :: Highlight parts of the article

* Ref Card

[[https://www.gnu.org/software/emacs/refcards/pdf/gnus-refcard.pdf][GNUS 5.11 Reference Card]]

|-----+---------+------|
| Key | Command | Desc |
|-----+---------+------|
|     |         |      |
|-----+---------+------|

** Group Mode

Control

|-----+---------+---------------------------------|
| Key | Command | Desc                            |
|-----+---------+---------------------------------|
| q/Q |         | Quit GNUS (without saving)      |
| z   |         | suspend (kill all Gnus buffers) |
| Z   |         | clear the dribble buffer        |
| r   |         | reread the init script (reset)  |
| R   |         | Restart Gnus                    |

Navigation

|---------+---------+----------------------------------------------|
| Key     | Command | Desc                                         |
|---------+---------+----------------------------------------------|
| </>     |         | beginning/end of buffer                      |
| n/p     |         | next/prev (with unread)                      |
| N/P     |         | next/prev                                    |
| M-n/M-p |         | next/prev group on same or lower level       |
| ,/.     |         | jump to first/lowest-level group with unread |
| j       |         | jump to a group                              |
|---------+---------+----------------------------------------------|

Interact

|-------+---------+-----------------------------------------------------|
| Key   | Command | Desc                                                |
|-------+---------+-----------------------------------------------------|
| a     |         | post an article to a group                          |
| C-u a |         | post, using group under point to find posting style |
| m     |         | mail a message to someone                           |
| C-u m |         | mail, using group under point to find posting style |
|       |         |                                                     |

*** Group Subscribedness-Levels

*** List Groups

*** Create/Edit Foreign Groups

*** Unsubscribe, Kill and Yank Groups

*** Mark Groups

*** Group-Unplugged

*** Group Topics

Prefix T

|---------+---------+----------------------------------|
| Key     | Command | Desc                             |
|---------+---------+----------------------------------|
| j       |         | jump                             |
| n       |         | new                              |
| m/c     |         | move/copy group to topic         |
| M/C     |         | move/copy groups matching regexp |
| M-n/M-p |         | next/prev topic                  |
| s/h     |         | show/hide                        |
| r       |         | rename topic                     |
|---------+---------+----------------------------------|

Other commands:

+ C-k/C-y :: kill/yank group or topic

**** Topic Sorting

** Summary Mode

+ Gnus will hide the messages you've already read. Use =/o= too show these.
+ Use =Y g= to refresh the summary buffer.

*** Select Articles

*** Threading

*** Limiting

*** Sort the Summary-Buffer

*** Score (Value) Commands

*** Output Articles

*** Extract Series (Uudecode etc)

*** MIME Operations from the Summary-Buffer

*** Post, Followup, Reply, Forward, Cancel

*** Message Composition

**** Jumping in message-buffer

**** Attachments/MML

*** Mark Articles

**** Mark Based on Score

**** The Process Mark

**** Mark Indication-Characters

*** Summary-Unplugged

*** Mail-Group Commands

*** Draft-Group Commands

*** Exit the Summary-Buffer

** Article Mode (reading)

*** Wash the Article-Buffer

**** Blank lines and Whitespace

**** Picons, X-Faces, Smileys

**** Time and Date

*** HIde/Highlight Parts of the Article

*** MIME operations from the Article-Buffer (reading)

** Server Mode

*** Unplugged-Server

** Browse Server Mode
