:PROPERTIES:
:ID:       ae2d42cf-21c4-45ff-9d52-6fb65e1ad7b6
:END:
#+TITLE: nixpkgs: Fixing tinygrad for AMD ROCm
#+CATEGORY: slips
#+TAGS:  
* Roam
+ [[id:2049060e-6755-4a64-b295-F7B563B41505][NixOS]]

* Notes

IDK whether this is an easy fix and I haven't thought about hacking on a local
checkout of nixpkgs yet.

** Substitutions

tinygrad replaced =compiler_(hip).py= with =amd= and now contains these references

#+begin_src grep
tinygrad/runtime/autogen/__init__.py:90:    case "hip": return load("hip", "os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libamdhip64.so'", ["/opt/rocm/include/hip/hip_ext.h",
tinygrad/runtime/autogen/__init__.py:91:                            "/opt/rocm/include/hip/hiprtc.h", "/opt/rocm/include/hip/hip_runtime_api.h", "/opt/rocm/include/hip/driver_types.h"],
tinygrad/runtime/autogen/__init__.py:92:                            args=["-D__HIP_PLATFORM_AMD__", "-I/opt/rocm/include", "-x", "c++"], prolog=["import os"])
tinygrad/runtime/autogen/__init__.py:94:      return load("comgr_3" if nm == "comgr_3" else "comgr", "[os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libamd_comgr.so', 'amd_comgr']",
tinygrad/runtime/autogen/__init__.py:95:                  ["/opt/rocm/include/amd_comgr/amd_comgr.h"], args=["-D__HIP_PLATFORM_AMD__", "-I/opt/rocm/include", "-x", "c++"],
tinygrad/runtime/autogen/__init__.py:97:    case "hsa": return load("hsa", "[os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libhsa-runtime64.so', 'hsa-runtime64']", [
tinygrad/runtime/autogen/__init__.py:105:                                args=["-I/opt/rocm/include", "-x", "c++"])
tinygrad/runtime/autogen/am/__init__.py:15:                                   args=["-I/opt/rocm/include", "-x", "c++"], tarball=am_src)
tinygrad/runtime/autogen/am/__init__.py:17:                                   args=["-I/opt/rocm/include", "-x", "c++"], tarball=am_src)
tinygrad/runtime/autogen/am/__init__.py:19:                                   args=["-I/opt/rocm/include", "-x", "c++"], tarball=am_src)
tinygrad/runtime/autogen/comgr.py:5:dll = DLL('comgr', [os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libamd_comgr.so', 'amd_comgr'])
tinygrad/runtime/autogen/comgr_3.py:5:dll = DLL('comgr_3', [os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libamd_comgr.so', 'amd_comgr'])
tinygrad/runtime/autogen/hip.py:5:dll = DLL('hip', os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libamdhip64.so')
tinygrad/runtime/autogen/hsa.py:5:dll = DLL('hsa', [os.getenv('ROCM_PATH', '/opt/rocm')+'/lib/libhsa-runtime64.so', 'hsa-runtime64'])
tinygrad/runtime/support/compiler_amd.py:18:  for p in ['/opt/rocm/llvm/bin/llvm-objdump', 'llvm-objdump-21', 'llvm-objdump-20', 'llvm-objdump']:
tinygrad/runtime/support/compiler_amd.py:74:      "-I/opt/rocm/include", "-Xclang -disable-llvm-passes", "-Xclang -aux-triple", "-Xclang x86_64-unknown-linux-gnu"]
tinygrad/runtime/support/compiler_amd.py:111:                        f"--offload-arch={self.arch}", "-I/opt/rocm/include/hip", "-o", bcf.name, srcf.name] + self.extra_options, check=True)
#+end_src
