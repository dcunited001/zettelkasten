:PROPERTIES:
:ID:       54cc71a0-570a-451d-8b84-df502c42b36b
:END:
#+TITLE: Proxmox: Setup New VM Host
#+CATEGORY: slips
#+TAGS:

+ [[id:cf2bd101-8e99-4a31-bbdc-a67949389b40][Virtualization]]
+ [[id:bdae77b1-d9f0-4d3a-a2fb-2ecdab5fd531][Linux]]

* Basics

Most of this info is in Proxmox Docs =10.9=

** Setup Network

**** TODO update the following
+ configure =vmbrX= virtual bridges
  - configure trunking where necessary

** Setup Apt
+ Add downloads.proxmox.com to apt sources
+ Update firewall to allow fetching from apt sources
+ Run =netselect-apt= to select a set of mirrors
  - Check the mirror selection in =/etc/apt/sources.list=
+ Run =apt-get update=

** Setup GPU
*** Setup Passthrough
**** Blacklist modules
=echo blacklist amdgpu >> /etc/

**** Setup VFIO blacklist

Append to ids list if necessary

#+begin_src shell
# for GPU
# emit to /etc/modprobe.d/vfio.conf
options vfio-pci ids=1002:73df,1002:ab28
#+end_src

**** Ensure BIOS Configured
+ IOMMU, SRV-IO (?) and other options need to be turned on. Don't boot with the AMD GPU.
+ For some games, AMD GPU resize bar and other options are needed


**** Ensure modules are loaded

=lsmod | grep vfio= should indicate:

#+begin_quote
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
#+end_quote

If they're lacking, add them to =/etc/modules=

Run =update-initramfs -u -k all= to update modules/grub config

**** Update Linux params in Grub

Open =/etc/default/grub= and set =GRUB_CMDLINE_LINUX_DEFAULT=

+ For AMD CPU's, the =amd_iommu= feature will automatically be turned on if AMD-Vi
  is detected.
+ Setting full device passthrough with =iommu=pt= will help address
  performance issues and may be needed for gaming.
  - Full passthrough allows DMA
    which apps may need for consistency -- otherwise memory race-conditions or wierd
    things will happen.
  - Resize BAR (enabling GPU to access more than 4G of CPU RAM) may require

*** Create passthrough VM

Machine type should be =q35=, which was formerly discouraged for GPU
passthrough. However, =i440fx= only supports PCI.

** Setup Soundcard

*** Pipewire/Wireplumber problems

Even though I have used this device on the VM before, it is causing problems with wireplumber now.

*** Ensure VFIO device owned by guest

When the VM starts, it displays the message below.

#+begin_quote
kmv: vfio: Cannot reset device 0000:10:00.4, depends on group 33 which is not allowed.
#+end_quote

The motherboard's soundcard is attached to other devices, so a modprobe.d rule
needs to be created to handle this:

#+begin_src shell
# emit to /etc/modprobe.d/vfio.conf
options vfio-pci ids=1022:1487
#+end_src

Append to list if necessary

*** Setup Passthrough

This can be passed through as the subdevice on the VM

** Setup SR-IOV for networking

+ igb :: intel driver
  - Intel I350 has two subdevices (one for each port)
  - Intel I211 has one device ([[https://www.intel.com/content/www/us/en/products/details/ethernet/gigabit-controllers/i211-controllers/docs.html?grouping=rdc%20Content%20Types&sort=title%3Aasc&s=Newest][docs]], [[https://d2pgu9s4sfmw1s.cloudfront.net/UAM/Prod/Done/a062E00001ZcBZVQA3/062cbab4-15b4-4082-8c8a-eef76cd2e5ce?Expires=1660705367&Key-Pair-Id=APKAJKRNIMMSNYXST6UA&Signature=KlL0Rt~JbJQBX1bTarfGEsZCKWIGnoWkEtDxXwXCoMvq88pNiQWjOXG4xP~0rersrgbCRZMDhQX7-UebiSQJAR0ZBit6PhrObKdXAewWa0Bz-OasL3gYRxeHR~TyX2XslPlJDtb--UzFSSpetl69OcugQ40Vof0REuHHU-Bf039DncbFzUc96uh-RsqJz-6LXknUWL~JiHvL7hy7AYYECOWWiSAhb9b9SBGP958aru035C1~wyCpyHubX-G8KSxXPNyIqjkmuCCSIL3sX1Qh9PQ1yt3bS5wKvXp1eqPzkufq9IKN70KWS8pHLa67U8P2AuEonzjFxqieJN6RhUwKBw__][datasheet]])


+ r8169 :: Realtek driver
  - RTL8125 has one device
  - installing the latest proprietary drivers may increase performance ... but
    probably not on an old cisco switch
  - this thread indicates that [[https://archived.forum.manjaro.org/t/i-learned-from-a-document-that-rtl8125-supports-sr-iov-but-in-fact-sr-iov-does-not-seem-to-work/154451/5][Realtek disabled SR-IOV]] ... and doesn't provide
    datasheets :(
    - here, take my money. what is it $300 for a 4-port device? one sec. let me
      upgrade my switch (and et cetera). sweet 1.3 Gb/s
    - it might be enough for TrueNAS

*** Basics

Ensure SR-IOV is enabled in BIOS, that iommu is enabled in =/etc/default/grub= and update initramfs

PCIe address structure ... =[domain:]bus:device.function=

*** Files

+ /sys/class/net/$ifname/device/sriov_numvfs :: update max number of VF's
  - echo will update this value, but device must be off
+ =/etc/modprobe.d/$driver.conf=
  - may require setting an option like =options $driver max_vfs=4=

*** Links
+ On Intel Data-Plane Dev Kit
  - [[https://www.intel.com/content/www/us/en/developer/articles/technical/using-sr-iov-to-share-an-ethernet-port-among-multiple-vms.html][Configure SR-IOV for networking]]
  - Intel [[https://doc.dpdk.org/guides/nics/intel_vf.html][Virtual Function (VF) Driver]]
+ [[https://groups.google.com/g/cloudlab-users/c/-89DREDEsC0?pli=1][Enabling SR-IOV on bare-metal]]
  - describes probing systems and extending the number of VF's in a live system
    (without reboot)
+ [[https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-pci_devices-pci_passthrough][Redhat PCI Device Assignment with SR-IOV]]

*** Getting System Info



#+begin_example shell
# -s [[[[domain]]]:bus]:[device].[function]
# colons optional
lspci -vvs 04:00 | grep SR-IOV
#+end_example


*** Create subdevices
