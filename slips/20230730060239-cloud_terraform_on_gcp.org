:PROPERTIES:
:ID:       4ea74826-8caf-47d0-bb40-f23e27359d07
:END:
#+TITLE: Cloud: Terraform On GCP
#+CATEGORY: slips
#+TAGS:

* Docs

* Resources

* Notes

** Pricing

*** Tiers

+ TF Enterprise is basically equivalent to the TF Cloud Business Tier

|                      | TF Open Source            | TF Cloud | TF Enterprise |
|----------------------+---------------------------+----------+---------------|
| License/Cost         | none                      | 3 tiers  | $$$$          |
| Managed              | No                        | Yes      | Money Talks   |
| Hosting              | Local Machine or Cloud VM | SaaS     | On-Prem       |
| Concurrent Deploys   | No                        | Yes      | Yes           |
| GUI                  | CLI Only                  | Yes      | Yes           |
| Operational Overhead | The sky is the limit      | Light    | Heavy         |



** Concepts

+ Manage infrastructure
+ Track changes
+ Automate changes
+ Standardize configurations

*** Provisioning vs Configuration

The concepts are blurred and aren't simple to discriminate. In networking
contexts, whether signaling to routers or GCP network device objects,
provisioning may include sending a subset of network state sufficient to
complete the configuration. Sometimes, you may consider this configuration
management, but the two are not separated from each other in semantics or in
your processes/code. This convolutes your projects and processes.

+ Provisioning :: signaling to VM hosts, cloud API's, network controllers or
  rack controllers to manage objects.

  In the cloud, the API provides an interface with rules/logic. You signal to it
  and on the backend it prepares the cloud provider state. You receive signals
  from it in response and proceed with provisioning. On bare metal, this would
  involve some cfg mgmt.

+ Config management :: distributing configuration/state to entities on the
  network, usually internal to those entities. e.g. cloud-config or ssh keys or
  network device configuration.

*** Stages/Commands

| write   |   |
| init    |   |
| plan    |   |
| apply   |   |
| destroy |   |

*init*

Basically downloads modules and preps the TF environment.

*plan*

The TF plan output is a diff & can be saved for input to later TF commands.

+ Use =-out= to save and =terraform show -json $file= to convert to json. Use
  =jq= FTW. The JSON Format is [[https://developer.hashicorp.com/terraform/internals/json-format][here]].
+ The plan instructions are sorted according to resource identifiers

*apply*

This gives you a chance to review/modify values (before running apply) or to
abort. Terraform apply will try to destroy resources according to the
constraints imposed by the provider's backend (the plan should

+ The =terraform destroy= command is an alias for =terraform apply -destroy=
+ The =-state= and =-state-out= options allow you to control input/output
+ State locking with =-lock= ... interesting
+ Control threads/tasks with =-parallelism=

  | option       | default           |
  |--------------+-------------------|
  | -state       | terraform.tfstate |
  | -state-out   | -state            |
  | -backup      | -state-out        |
  | -parallelism | 10                |

*fmt*

Don't commit shit. Lint your codes. What is this a blog?

*validate*

Run some checks. Helps ensure adherence compliance

*** Running Terraform

+ TF itself doesn't require authentication, only the provider.
+ TF on Cloud Shell: preauthenticated, but still needs roles assigned to do
  anything useful.
+ TF on a workstation: requires =gcloud auth application-default= to authenticate
+ TF on a VM: configure Google Service Accounts
+ TF outside GCP: use workload identiy fedration, generate short-lived SA key
  and set env variables. SA key rotation not allowed.

** Projects

*** Providers

*** Inputs/Outputs

+ Define inputs/outputs and most logic in =main.tf=. Outputs connect modules to
  subsequent modules (visualize a modular synth with patch cables)
+ Define variables in =vars.tf=. Change variable values for various deployment
  environments in file =terraform.tfvars=, but these should wind up in Git (esp
  for gitops)

* Roam
+ [[id:8a6898ca-2c09-47aa-9a34-a74a78f6f823][Cloud]]
+ [[id:ac2a1ae4-a695-4226-91f0-8386dc4d9b07][DevOps]]
