:PROPERTIES:
:ID:       693d1582-91ab-4845-abdc-89a5330f853a
:END:
#+TITLE: Red Team: Pentest Collaboration Framework Schema
#+CATEGORY: slips
#+TAGS:
* Roam
+ [[id:d0d5896c-0cf5-4fa7-bf37-a2e3499c69d2][Red Team]]
+ [[id:ea11e6b1-6fb8-40e7-a40c-89e42697c9c4][Networking]]

* Docs
+ [[https://gitlab.com/invuls/pentest-projects/pcf/-/blob/master/system/db.py?ref_type=heads][./system/db.py]]

* Notes

* Frameworks

Comparison (table from [[https://gitlab.com/invuls/pentest-projects/pcf][gitlab.com:invuls/pentest-projects/pcf]])

+ x :: has feature
+ $ :: paid feature
+ . :: partial feature

|----------------------------------------+-----+------+--------+---------+-------------+------------+------+-----------|
| *Name*                                   | PCF | Lair | Dradis | Faraday | AttackForge | PenTest.WS | Hive | Cervantes |
|----------------------------------------+-----+------+--------+---------+-------------+------------+------+-----------|
| Portable                               | x   |      |        |         |             | $          |      |           |
| Cross-platform                         | x   | x    | x      | x       |             |            |      |           |
| Free                                   | x   | x    | .      | .       | .           | .          | .    | x         |
| NOT deprecated!                        | x   |      | x      | x       | x           | x          |      | x         |
| Data export                            | x   | .    | x      | x       | x           | .          | x    | .         |
| Chat                                   | x   |      |        |         | x           |            | x    |           |
| Made for sec specialists, not managers | x   | x    | x      | x       |             | x          | .    | .         |
| Report generation                      | x   |      | x      | x       | x           | x          | x    | x         |
| API                                    | x   | .    | x      | x       | x           | x          | x    | x         |
| Issue templates                        | x   |      | x      | x       | x           |            | x    | x         |
|----------------------------------------+-----+------+--------+---------+-------------+------------+------+-----------|

* PCF Schema

** Get Schema
#+name: awkCsplit
#+begin_src awk :tangle img/tmp.awkCsplit
BEGIN { count=0 }
($0 ~/cursor\.execute\('''/) { ++count; }
($0 ~/'''\)$/) { ++count; print $0; }
(count % 2 == 1) { print $0; }
(count % 2 == 0) { next; }
#+end_src

#+begin_src sh
file=img/tmp.pcf.dbinit.py
curl -s "https://gitlab.com/invuls/pentest-projects/pcf/-/raw/master/system/db_initiation.py?ref_type=heads" \
    > $file
#+end_src

#+RESULTS:

#+name: pcfSchema
#+begin_src sh :results output verbatim file :file img/pcfschema.sql
awk -f img/tmp.awkCsplit img/tmp.pcf.dbinit.py \
    | sed -e "s/ \+cursor.execute('''//g" \
    | sed -e "s/ \+);\?''')/);/g" \
    | sed -e "s/^\s\+\(.*\)$/\1/g"
    #+end_src

#+RESULTS: pcfSchema
[[file:img/pcfschema.sql]]
** Make Schema
#+begin_src sh
sql=img/pcfschema.sql
db=img/pcfschema.sqlite
sqlite3 $db < $sql
#+end_src

#+RESULTS:

** Generate SVG
Now that schema is in there, use [[https://gitlab.com/Screwtapello/sqlite-schema-diagram][gitlab:ScrewTapello/sqlite-schema-diagram]]

#+name: pcfSchemaSvg
#+begin_src sh :results output verbatim file :file img/pcfschema.nokeys.svg
sqltool=/tmp/tmp.yLqVwIRly1
dot=img/pcfschema.dot
db=img/pcfschema.sqlite
sqlite3 $db -init "$sqltool/sqlite-schema-diagram.sql" "" > $dot 2>/dev/null
dot -Tsvg -Kdot -G"rankdir='LR'" $dot # > $dot.svg
#+end_src

#+RESULTS:
[[file:img/pcfschema.nokeys.svg]]

.... $#@! there's no keys.

Adding =FOREIGN KEY(someplace_id) REFERENCES someplaces(id)= to some places would
help the graph a ton.

** Fix Keys

Okay ... that's moderately better, but there's still not much of a point (damit)
since it only barely has a concept of ports. The application is meant for a
different aspect of pentesting workflows.

#+call: pcfSchemaSvg() :file img/pcfschema.svg

#+RESULTS:
[[file:img/pcfschema.svg]]

They're text though (also not a "correct" set of FKs: probably some bad
constraints & some unnecessary)

#+begin_example diff
19c19,20
< admin_email text default ''
---
> admin_email text default '',
> FOREIGN KEY(admin_id) REFERENCES Users(id)
28c29,30
< project text default ''
---
> project text default '',
> FOREIGN KEY(user_id) REFERENCES Users(id)
45c47,48
< admin_id text
---
> admin_id text,
> FOREIGN KEY(admin_id) REFERENCES Users(id)
55c58,60
< os text default ''
---
> os text default '',
> FOREIGN KEY(project_id) REFERENCES Projects(id)
>
63c68,70
< user_id text
---
> user_id text,
> FOREIGN KEY(user_id) REFERENCES Users(id),
> FOREIGN KEY(host_id) REFERENCES Hosts(id)
77c84,85
< base64 text default ''
---
> base64 text default '',
> FOREIGN KEY(port_id) REFERENCES Ports(id)
88c96,98
< project_id text
---
> project_id text,
> FOREIGN KEY(user_id) REFERENCES Users(id),
> FOREIGN KEY(project_id) REFERENCES Projects(id)
110c120,122
< intruder text default ''
---
> intruder text default '',
> FOREIGN KEY(project_id) REFERENCES Projects(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
125c137,139
< cmd text default ''
---
> cmd text default '',
> FOREIGN KEY(project_id) REFERENCES Projects(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
137c151,153
< base64 text default ''
---
> base64 text default '',
> FOREIGN KEY(project_id) REFERENCES Projects(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
150c166,168
< project_id text
---
> project_id text,
> FOREIGN KEY(project_id) REFERENCES Projects(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
160c178,179
< type text default 'html'
---
> type text default 'html',
> FOREIGN KEY(user_id) REFERENCES Users(id)
167c186,188
< user_id text
---
> user_id text,
> FOREIGN KEY(project_id) REFERENCES Projects(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
175c196,197
< time bigint
---
> time bigint,
> FOREIGN KEY(chat_id) REFERENCES Chats(id)
185c207,208
< save_credentials bigint default 0
---
> save_credentials bigint default 0,
> FOREIGN KEY(project_id) REFERENCES Projects(id)
193c216,217
< request text default ''
---
> request text default '',
> FOREIGN KEY(sniffer_id) REFERENCES tool_sniffer_http_info(id)
203c227,229
< visible BIGINT default 0
---
> visible BIGINT default 0,
> FOREIGN KEY(team_id) REFERENCES Teams(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
213c239,241
< base64 text default ''
---
> base64 text default '',
> FOREIGN KEY(team_id) REFERENCES Teams(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
221c249,250
< duration BIGINT default 0
---
> duration BIGINT default 0,
> FOREIGN KEY(user_id) REFERENCES Users(id)
244c273,275
< intruder text default ''
---
> intruder text default '',
> FOREIGN KEY(team_id) REFERENCES Teams(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
266c297,299
< replace_rules text default '[]'
---
> replace_rules text default '[]',
> FOREIGN KEY(team_id) REFERENCES Teams(id),
> FOREIGN KEY(user_id) REFERENCES Users(id)
280c313,314
< services text default '{}'
---
> services text default '{}',
> FOREIGN KEY(project_id) REFERENCES Projects(id)
#+end_example
