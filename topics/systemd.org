:PROPERTIES:
:ID:       df7f060a-d663-4eaa-844e-f8baec7c94a2
:END:
#+TITLE: SystemD
#+DESCRIPTION:
#+TAGS:

* Roam
+ [[id:bdae77b1-d9f0-4d3a-a2fb-2ecdab5fd531][Linux]]

* Docs

* Resources

** Nixos

+ [[https://github.com/NixOS/nixpkgs/blob/85fe7380cc14e96a569f53fc07133b2db55049d9/nixos/lib/systemd-lib.nix#L70][nixos/lib/systemd-lib.nix]] regexp for systemd unit types
+ [[https://github.com/NixOS/nixpkgs/blob/85fe7380cc14e96a569f53fc07133b2db55049d9/nixos/lib/systemd-unit-options.nix#L64][nixos/lib/systemd-unit-options.nix]] spec/validation of systemd unit options
+ [[https://github.com/NixOS/nixpkgs/blob/85fe7380cc14e96a569f53fc07133b2db55049d9/nixos/modules/system/boot/systemd/user.nix#L71][nixos/modules/system/boot/systemd/user.nix]] handling units for users

** SystemD

*** On Demand Activation

+ Should be everyday & very simple, but I don't commonly see this outside of
  packages: [[https://erlangen-sheppy.medium.com/on-demand-activation-of-arbitrary-applications-3b577eb116b6][on-demand-activation-of-arbitrary-applications]]
+ Why have I never encountered any libraries that generate/manage this
  toml/conf? I'm guessing Jinja does it more than half the time.

* Topics
** Examples
*** NixOS

These queries are confusing.

+ I'm looking for =$type= mentioned in any =[ "fdsa.$type" ]= where attrs are set.
+ It doesn't catch directives that span over multiple lines (see [[https://github.com/nix-community/home-manager/blob/ca2ab1d877a24d5a437dad62f56b8b2c02e964e9/modules/services/radicle.nix#L101][radical.nix]]).
  simple, but I'm just trying to find entry-points to elucidate patterns
+ These queries only capture =requires = [...];=, not =Requires = "foobar.service";=
+ Many units could be leaf-level or pulled in from a package.
+ Too many syntax patterns are used to specify =...systemd.(user\.)?.<service>=

I would evaluate =nix= expressions and extract JSON, but they seem a bit difficult
to access in the repl. some evaluation is required for modules whose services
depend on config or module interactions.

**** Nixpkgs

Units specifying an edge to another unit.

#+name: nixpkgsSystemdEdges
#+begin_src shell :results output table :var type="target" checkout="/data/ecto/nixos/nixos/nixpkgs" include="" exclude=""
#  'wantedby\s*=.*\[.*".*\.target"' # '.*\[.*".*\.target"'
grep  --include='*.nix' -ire '=.*\[.*".*\.'$type'"' $checkout \
| grep -i "$include" | grep -iv "${exclude:-\0}" | sed -E 's/.*(\[.*\]);/\1/g' \
| grep -E '^\[' | sed -E 's/\[ *"(.*)" *\].*/\1/g' \
| sort | uniq
# the null char in exclude is probably unsafe... it's also temperamental
# (1) req. echo -e (2) can't quote a variable after assigning nullchar
# (3) grep warns you

# d=$(date +%s | rev); h=$(echo $d | sha256sum | rev); grep -v $h # - \bacd8b8ceb8c ... lol woops
#+end_src

Files with units

#+name: nixpkgsSystemdFilesWithUnits
#+begin_src shell :results output table :var type="path" checkout="/data/ecto/nixos/nixos/nixpkgs"
grep -l --include='*.nix' -ire ' \+".*\.'$type'" \+' $checkout | grep -v 'nixos/tests/'
#+end_src

#+RESULTS: nixpkgsSystemdFilesWithUnits
| /data/ecto/nixos/nixos/nixpkgs/pkgs/development/python-modules/svg-path/default.nix    |
| /data/ecto/nixos/nixos/nixpkgs/pkgs/development/python-modules/jaraco-path/default.nix |
| /data/ecto/nixos/nixos/nixpkgs/nixos/modules/system/boot/systemd/initrd.nix            |
| /data/ecto/nixos/nixos/nixpkgs/nixos/modules/system/boot/systemd/user.nix              |
| /data/ecto/nixos/nixos/nixpkgs/nixos/modules/services/cluster/hadoop/default.nix       |
| /data/ecto/nixos/nixos/nixpkgs/nixos/modules/services/monitoring/thanos.nix            |
| /data/ecto/nixos/nixos/nixpkgs/nixos/modules/services/misc/zoneminder.nix              |

#+call: nixpkgsSystemdFilesWithUnits(checkout="/data/ecto/nixos/nixos/nixpkgs", type="timer")

***** Timers

These are usually setup using =wantedBy=

***** Targets
****** PartOf

#+call: nixpkgsSystemdEdges(checkout="/data/ecto/nixos/nixos/nixpkgs", type="target", include="partOf")

#+RESULTS:
| ax25-axports.target       | matrix-synapse.target | windmill.target |
| ceph-${daemonType}.target | multi-user.target     |                 |
| ceph.target               | network.target        |                 |
| firezone.target           | phpfpm.target         |                 |
| gitlab.target             | postgresql.target     |                 |
| graphical-session.target  | samba.target          |                 |
| kerberos-server.target    | sleep.target          |                 |
| lock.target               | unlock.target         |                 |

****** WantedBy

#+call: nixpkgsSystemdEdges(checkout="/data/ecto/nixos/nixos/nixpkgs")

| basic.target              | getty.target                 | initrd.target          | machines.target       | paths.target           | shutdown.target |
| bluetooth.target          | gitlab.target                | kerberos-server.target | mastodon.target       | peering-manager.target | sleep.target    |
| capsule@alice.target      | graphical-session-pre.target | kexec.target           | matrix-synapse.target | phpfpm.target          | sockets.target  |
| ceph-${daemonType}.target | graphical-session.target     | kubernetes.target      | multi-user.target     | poweroff.target        | sound.target    |
| ceph.target               | graphical.target             | lcd.target             | netbox.target         | reboot.target          | sysinit.target  |
| default.target            | halt.target                  | local-fs-pre.target    | network-online.target | remote-fs.target       | timers.target   |
| emergency.target          | healthchecks.target          | local-fs.target        | network-pre.target    | samba.target           | unlock.target   |
| firezone.target           | initrd-switch-root.target    | lock.target            | network.target        | sata-timeout.target    | zfs.target      |

Not including =wantedBy=

#+call: nixpkgsSystemdEdges(checkout="/data/ecto/nixos/nixos/nixpkgs", exclude="wantedBy")

| ax25-axports.target       | firezone.target        | nss-lookup.target           | windmill.target              |
| ceph-${daemonType}.target | fs.target              | nss-user-lookup.target      | xdg-desktop-autostart.target |
| ceph.target               | initrd-fs.target       | phpfpm.target               | zfs-import.target            |
| cfssl.target              | ipset.target           | postgresql.target           |                              |
| cloud-config.target       | keycloak.service       | rustdesk.target             |                              |
| dissect.target            | machines.target        | sysinit-reactivation.target |                              |
| dysnomia.target           | networking.target      | test-target.target          |                              |
| final.target              | nominatim-init.service | time-sync.target            |                              |
**** Home Manager


** Automation
*** Timers

#+begin_src shell
grep -ire 'wantedby\s*=.*\[.*"timers.target"' \
    --include='*.nix' /data/ecto/nixos/nixos/nixpkgs
#+end_src

*** Useful tasks


+ database backups
+ path activation (dev project? logs?)
+ cache cleanup
** Learning

*** =systemd-analyze dot=

**** System Targets

#+begin_src shell :results output file :file img/nix/systemd-analyze-system-targets.svg
systemd-analyze dot \
    --from-pattern='*.target' \
    --to-pattern='*.target' \
    | dot -Grankdir=LR -Tsvg
#+end_src

#+RESULTS:
[[file:img/nix/systemd-analyze-system-targets.svg]]

**** User Targets

For =programs.hyprland.withUWSM=

#+begin_src shell :results output file :file img/nix/systemd-analyze-user-targets.svg
systemd-analyze --user dot \
    --from-pattern='*.target' \
    --to-pattern='*.target' \
    | dot -Grankdir=TB -Tsvg
#+end_src

#+RESULTS:
[[file:img/nix/systemd-analyze-user-targets.svg]]


*** List Subcommands

See

**** Via Man
What are the systemd subcommands? =man systemctl= doesn't show much (i forgot
there are =systemd.$subcmd= commands)

#+begin_src sh :results output verbatim
# I couldn't retain the descriptions bc the regexp seemed to lead me towards
# weird matching groups.
man -k 'systemd' --sections=1 \
    | grep -e '^systemd' \
    | sed -E 's/\(.*//' \
    | sed -e 's/-/\//g' \
    | tree --fromfile .

# (the hierarchical organization here doesn't make sense ... )
#+end_src

I honestly just need to see whatever it is that my completion is seeing. There's
a ton of features that help with the CLI -- the ones I'm looking for are mostly
_interactive_ features, so they're not going to show up in any scripts that I can
grep.
*** Enumerating =.service= files

#+begin_src shell
systemctl --user list-units --output=json | jq '.'
#+end_src

*** Enumerating =.service= files (WRONG)

#+begin_quote
not for lack of trying...

Though this does discover units not in memory
#+end_quote

It's tough to get =find= to work

#+begin_src shell
find /home/dc/.local/share/{flatpak,systemd} -type f -name "*.service"
#+end_src

Use =systemd-path=

#+begin_src shell :results output verbatim
unitRgx='unit: '
# cut -f1 -d' ' # doesn't split paths correctly
paste \
    <(systemd-path --no-pager | grep -e "$unitRgx" | sed -E 's/^(.*): (.*)$/\1/') \
    <(systemd-path --no-pager | grep -e "$unitRgx" | sed -E 's/^(.*): (.*)$/\2/')
#+end_src

#+RESULTS:
: systemd-system-unit	/nix/store/ymmaa926pv3f3wlgpw9y1aygdvqi1m7j-systemd-257.6/lib/systemd/system
: systemd-user-unit	/nix/store/ymmaa926pv3f3wlgpw9y1aygdvqi1m7j-systemd-257.6/lib/systemd/user
: systemd-search-system-unit	/etc/systemd/system.control:/run/systemd/system.control:/run/systemd/transient:/run/systemd/generator.early:/etc/systemd/system:/nix/var/nix/profiles/default/lib/systemd/system:/etc/systemd/system.attached:/run/systemd/system:/run/systemd/system.attached:/run/systemd/generator:/nix/store/ymmaa926pv3f3wlgpw9y1aygdvqi1m7j-systemd-257.6/lib/systemd/system:/run/systemd/generator.late
: systemd-search-user-unit	/home/dc/.config/systemd/user.control:/run/user/1000/systemd/user.control:/run/user/1000/systemd/transient:/run/user/1000/systemd/generator.early:/home/dc/.config/systemd/user:/etc/xdg/systemd/user:/home/dc/.config/guix/current/etc/xdg/systemd/user:/home/dc/.guix-home/profile/etc/xdg/systemd/user:/home/dc/.guix-profile/etc/xdg/systemd/user:/home/dc/.local/share/flatpak/exports/etc/xdg/systemd/user:/var/lib/flatpak/exports/etc/xdg/systemd/user:/home/dc/.nix-profile/etc/xdg/systemd/user:/home/dc/.local/state/nix/profile/etc/xdg/systemd/user:/etc/profiles/per-user/dc/etc/xdg/systemd/user:/nix/var/nix/profiles/default/etc/xdg/systemd/user:/run/current-system/sw/etc/xdg/systemd/user:/etc/systemd/user:/run/user/1000/systemd/user:/run/systemd/user:/run/user/1000/systemd/generator:/home/dc/.local/share/systemd/user:/gnu/store/mpbhcsairkigzv53dyj6k779dwy2w9d0-shared-mime-info-2.3/share/systemd/user:/gnu/store/rx9fvgchvhjf0bvlad6xsaxkszjw622m-glib-2.83.3/share/systemd/user:/gnu/store/jd59bp9az0fbyrjniar2qd40il5ak4rd-gtk+-3.24.43/share/systemd/user:/gnu/store/m5vcc81k4d27509a708j6swdmqlkkpav-emacs-next-pgtk-31.0.50-1.9663c95/share/systemd/user:/home/dc/.local/share/flatpak/exports/share/systemd/user:/nix/store/vqlrn4r4pvgfwv2yqcc0n985974y3hrb-desktops/share/systemd/user:/home/dc/.config/guix/current/share/systemd/user:/home/dc/.guix-home/profile/share/systemd/user:/home/dc/.guix-profile/share/systemd/user:/var/lib/flatpak/exports/share/systemd/user:/home/dc/.nix-profile/share/systemd/user:/home/dc/.local/state/nix/profile/share/systemd/user:/etc/profiles/per-user/dc/share/systemd/user:/nix/var/nix/profiles/default/share/systemd/user:/run/current-system/sw/share/systemd/user:/nix/store/ymmaa926pv3f3wlgpw9y1aygdvqi1m7j-systemd-257.6/lib/systemd/user:/run/user/1000/systemd/generator.late

Just the paths and pass to find

#+begin_src shell :results output verbatim
unitRgx='unit: '
#pathRgx='dc/.local'
#pathRgx='/'
pathRgx='/etc/systemd/user'

sysPaths=$(systemd-path --no-pager | grep -e "$unitRgx" \
    | sed -E 's/^(.*): (.*)$/\2/' | tr ':' '\n' \
    | sort | uniq | grep -E "$pathRgx")

# cant pass directly to find?
sysPaths=($(echo ${sysPaths[@]} | tr '\n' ' '))

find ${sysPaths[@]} -follow -name '*.service' -type f -printf '%p\n' \
    | while read -n f; do
    # systemctl show --output=json jq '.'
    echo "congratulations youre an idiot"
done
#+end_src

#+RESULTS:
#+begin_example
/etc/systemd/user/graphical-session.target.wants/hypridle.service
/etc/systemd/user/graphical-session.target.wants/yubikey-touch-detector.service
/etc/systemd/user/default.target.wants/nixos-activation.service
/etc/systemd/user/pipewire.service.wants/wireplumber.service
/etc/systemd/user/nixos-activation.service
/etc/systemd/user/dbus.service
#+end_example
** Commands

*** systemd-path

#+begin_src shell
alias sysupath='systemd-path user-shared'
alias sysdpath='systemd-path system-shared'
#+end_src

** All Commands

Using Emacs' =embark=


* Issues
