:PROPERTIES:
:ID:       5aa36ac8-32b3-421f-afb1-5b6292b06915
:END:
#+title: VyOS
#+AUTHOR:    David Conner
#+EMAIL:     noreply@te.xel.io
#+DESCRIPTION: notes

VyOS has =nftables= and a decent DSL with fairly good ansible support.

+ The DSL is implemented in OCaml.
+ It only supports x86 for now.
+ It's missing some of the plug-in functionality of OPNsense (packet/traffic
  inspection), but has the ability to run images in containers with
  routing/firewall on the container host. So you could set up a container to do
  much of what the PFSense and OPNsense ecosystem allows (see the [[https://docs.vyos.io/en/stable/configuration/container/index.html#example-configuration][Zabbix
  container example]])

* Docs

+ [[https://docs.vyos.io/en/stable/automation/index.html][Automation]] and [[https://docs.vyos.io/en/stable/automation/command-scripting.html#executing-pre-hooks-post-hooks-scripts][pre/post hooks]]
+ [[https://docs.vyos.io/en/stable/cli.html#configuration-overview][Configuration overview]] (navigating the router CLI like with IOS
  shortcuts/help)
+ [[https://docs.vyos.io/en/stable/troubleshooting/index.html][Troubleshooting]]
+ [[https://support.vyos.io/support/solutions/articles/103000096255-what-are-the-hardware-requirements-][Hardware Requirements]]

** How to
+ [[https://docs.vyos.io/en/stable/configexamples/index.html][Configuration Blueprints]] and [[https://docs.vyos.io/en/stable/configexamples/index.html#configuration-blueprints-autotest][Autotest Blueprints]]
+ [[https://docs.vyos.io/en/sagitta/contributing/build-vyos.html#][Build a VyOS ISO]]

** DSL

+ [[https://docs.vyos.io/en/stable/configuration/firewall/index.html][firewall]]
+ [[https://docs.vyos.io/en/stable/configuration/container/index.html][container]]
+ [[https://docs.vyos.io/en/stable/configuration/interfaces/index.html][interfaces]]
  + [[https://docs.vyos.io/en/stable/configuration/interfaces/openvpn.html][OpenVPN]] (with LDAP)

** Community
+ [[https://forum.vyos.io/][forum.vyos.io]]
+ [[https://support.vyos.io/support/home][Support Portal]]
+ [[https://vyos.dev/][vyos.dev]]: Issue/Feature Tracking
+ Slack is for customers/contributors

* Resources
+ [[https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/][Battle of the Metal Routers]]
+ [[https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/][Battle of the Virtual Routers]] (VyOS)

* Topics

** Source
*** vyos-1x

+ Contains the XML that specifies the VyOS cli

**** XML Spec

Transclusion for XML specs in [[https://github.com/vyos/vyos-1x/blob/4d3e976271e30d70c8b2660d869a220de98d8c59/op-mode-definitions/][./op-mode-definitions]] and
[[https://github.com/vyos/vyos-1x/blob/4d3e976271e30d70c8b2660d869a220de98d8c59/interface-definitions][./interface-definitions]] is performed by [[https://github.com/vyos/vyos-1x/blob/4d3e976271e30d70c8b2660d869a220de98d8c59/scripts/transclude-template#L54][./scripts/transclude-template]]

Running =make op_mode_definitions= and =make interface_definitions= will generate
XML in the respective subdirs of =./build=. This can be queried with =xq= et alias.

***** Op Mode Definitions

+ [ ] in emacs, this results in a find/exec task that doesn't complete

***** Interface Definitions

+ [ ] building these requires having a compatible =libvyosconfig.so=

** Automation
+ Ansible is the main tool for configuration. Their ansible code includes
  inventory plugins, but I'm unsure of the discovery mechanisms.
+ Ansible requires paramiko for ssh
+ SSH/Shell is just as proficient as ansible for DSL configuration, but doesn't
  include the benefits (or overhead) of an Ansible project.
+ Napalm, Netmiko, Salt can also be used, but support/functionality seems
  limited.
+ [[https://docs.vyos.io/en/stable/automation/terraform/index.html][Terraform]] can provision a VyOS image (and Ansible configures).

+ [[https://docs.vyos.io/en/stable/automation/cloud-init.html][Cloud-init]] is also an option


** ZeroTier & Tailscale

[[https://lev-0.com/][lev-0]] has several series on setting Tailscale on VyOS as a podman service. The
VyOS DSL has a =container= subcommand. I haven't worked out the details, but
this seems like a fairly viable option.

** PKI
