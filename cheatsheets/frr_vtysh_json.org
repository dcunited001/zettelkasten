:PROPERTIES:
:ID:       027166e4-fbcc-4c75-8990-8198c7a47ae4
:END:
#+title: Cheatsheet: Frr vtysh commands

* Query the code-base :noexport:
** vtysh commands with json

To dump the following

#+begin_src shell :results output verbatim
frrRepo=/noobafoob-arbac
cd $frrRepo/doc/user
grep -re "^\.\. clicmd::.*json" --include='*.rst' \
    | sed -e 's/:\.\. clicmd:: /: /g'
#+end_src

Yes ... yes, really

* JSON via =vtysh=

#+begin_src shell
vtysh -c 'show ip route json'
# equivalent to: show ip route json
#+end_src

** Subcommands

*** zebra

+ show ip nht [vrf NAME] [A.B.C.D|X:X::X:X] [mrib] [json]
+ show ip nht route-map [vrf <NAME|all>] [json]
+ show evpn access-vlan [IFNAME VLAN-ID | detail] [json]
+ show debugging label-table [json]
+ show segment-routing srv6 manager [json]
+ show segment-routing srv6 locator [json]
+ show segment-routing srv6 locator NAME detail [json]
+ show segment-routing srv6 [locator NAME] sid [X:X::X:X] [json]
+ show fpm counters [json]
+ show fpm status [json]
+ show [ip|ipv6] route [vrf NAME|all|table TABLENO]
  [A.B.C.D|A.B.C.D/M|X:X::X:X|X:X::X:X/M] [json] [nexthop-group]
+ show interface [NAME] [{vrf VRF|brief}] [json]
+ show interface [NAME] [{vrf all|brief}] [json]
+ show nexthop-group rib [ID] [vrf NAME] [singleton [ip|ip6]] [type] [json]

*** vrrp

+ show vrrp [interface INTERFACE] [(1-255)] [json]

*** sharp

+ show sharp ted [verbose|json]
+ show sharp ted [<vertex [A.B.C.D]|edge [A.B.C.D]|subnet [A.B.C.D/M]>]
  [verbose|json]

*** rpki
+ show rpki configuration [vrf NAME] [json]
+ show rpki prefix <A.B.C.D/M|X:X::X:X/M> [ASN] [vrf NAME] [json]
+ show rpki as-number ASN [vrf NAME] [json]
+ show rpki prefix-table [vrf NAME] [json]
+ show rpki cache-server [vrf NAME] [json]
+ show rpki cache-connection [vrf NAME] [json]

*** routemap


+ show route-map [WORD] [json]

*** pimv6

+ show ipv6 pim [vrf NAME] group-type [json]
+ show ipv6 pim [vrf NAME] join [X:X::X:X [X:X::X:X]] [json]
+ show ipv6 pim vrf all join [json]
+ show ipv6 pim [vrf NAME] local-membership [json]
+ show ipv6 pim [vrf NAME] neighbor [detail|WORD] [json]
+ show ipv6 pim vrf all neighbor [detail|WORD] [json]
+ show ipv6 pim [vrf NAME] rp-info [json]
+ show ipv6 pim vrf all rp-info [json]
+ show ipv6 pim [vrf NAME] rpf [json]
+ show ipv6 pim vrf all rpf [json]
+ show ipv6 pim [vrf NAME] state [X:X::X:X [X:X::X:X]] [json]
+ show ipv6 pim vrf all state [X:X::X:X [X:X::X:X]] [json]
+ show ipv6 pim [vrf NAME] upstream [X:X::X:X [Y:Y::Y:Y]] [json]
+ show ipv6 pim vrf all upstream [json]
+ show ipv6 pim [vrf NAME] upstream-join-desired [json]
+ show ipv6 pim [vrf NAME] upstream-rpf [json]
+ show ipv6 pim [vrf NAME] interface traffic [WORD] [json]
+ show ipv6 mld [vrf NAME] interface [IFNAME] [detail|json]
+ show ipv6 mld [vrf NAME] statistics [interface IFNAME] [json]
+ show ipv6 mld [vrf NAME] joins [{interface IFNAME|groups X:X::X:X/M|sources
  X:X::X:X/M|detail}] [json]
+ show ipv6 mld [vrf NAME] groups [json]
+ show ipv6 multicast count [vrf NAME] [json]
+ show ipv6 multicast count vrf all [json]
+ show ipv6 mroute [vrf NAME] [X:X::X:X [X:X::X:X]] [fill] [json]
+ show ipv6 mroute [vrf NAME] count [json]
+ show ipv6 mroute vrf all count [json]
+ show ipv6 mroute [vrf NAME] summary [json]
+ show ipv6 mroute vrf all summary [json]
+ show ipv6 pim bsr [vrf NAME] [json]
+ show ipv6 pim bsr candidate-bsr [vrf NAME] [json]
+ show ipv6 pim bsr candidate-rp [vrf NAME] [json]
+ show ipv6 pim bsr candidate-rp-database [vrf NAME] [json]
+ show ipv6 pim bsr groups [vrf NAME] [json]
+ show ipv6 pim bsr rp-info [vrf NAME] [json]
+ show ipv6 pim bsm-database [vrf NAME] [json]

*** pim

+ show ip igmp [vrf NAME] join [json]
+ show ip igmp [vrf NAME] groups [INTERFACE [GROUP]] [detail] [json]
+ show ip igmp [vrf NAME] proxy [json]
+ show ip igmp [vrf NAME] sources [json]
+ show ip mroute [vrf NAME] [A.B.C.D [A.B.C.D]] [fill] [json]
+ show ip mroute [vrf NAME] count [json]
+ show ip mroute vrf all count [json]
+ show ip mroute [vrf NAME] summary [json]
+ show ip mroute vrf all summary [json]
+ show ip pim mlag [vrf NAME|all] interface [detail|WORD] [json]
+ show ip pim mlag summary [json]
+ show ip pim [vrf NAME] rp-info [A.B.C.D/M] [json]
+ show ip pim [vrf NAME] autorp [json]
+ show ip pim [vrf NAME] upstream [A.B.C.D [A.B.C.D]] [json]
+ show ip pim [vrf NAME] mlag upstream [A.B.C.D [A.B.C.D]] [json]
+ show ip pim bsr [vrf NAME] [json]
+ show ip pim bsr candidate-bsr [vrf NAME] [json]
+ show ip pim bsr candidate-rp [vrf NAME] [json]
+ show ip pim bsr candidate-rp-database [vrf NAME] [json]
+ show ip pim bsr groups [vrf NAME] [json]
+ show ip pim bsr rp-info [vrf NAME] [json]
+ show ip pim bsm-database [vrf NAME] [json]
+ show ip multicast count [vrf NAME] [json]
+ show ip multicast count vrf all [json]

*** pbr

+ show pbr nexthop-groups [NAME] [json]
+ show pbr map [NAME] [detail] [json]
+ show pbr interface [NAME] [json]

*** pathd

+ show sr-te pcep session [NAME] [json]

*** OSPF

+ show ip ospf [vrf <NAME|all>] [json]
+ show ip ospf interface [INTERFACE] [json]
+ show ip ospf neighbor [json]
+ show ip ospf [vrf <NAME|all>] neighbor INTERFACE [json]
+ show ip ospf neighbor detail [json]
+ show ip ospf [vrf <NAME|all>] neighbor A.B.C.D [detail] [json]
+ show ip ospf [vrf <NAME|all>] neighbor INTERFACE detail [json]
+ show ip ospf [vrf <NAME|all>] database [self-originate] [json]
+ show ip ospf [vrf <NAME|all>] database max-age [json]
+ show ip ospf [vrf <NAME|all>] database detail [LINK-STATE-ID] [adv-router
  A.B.C.D] [json]
+ show ip ospf [vrf <NAME|all>] database detail [LINK-STATE-ID] [self-originate]
  [json]
+ show ip ospf [vrf <NAME|all>] database
  (asbr-summary|external|network|router|summary|nssa-external|opaque-link|opaque-area|opaque-as)
  [LINK-STATE-ID] [adv-router A.B.C.D] [json]
+ show ip ospf [vrf <NAME|all>] database
  (asbr-summary|external|network|router|summary|nssa-external|opaque-link|opaque-area|opaque-as)
  [LINK-STATE-ID] [self-originate] [json]
+ show ip ospf route [detail] [json]
+ show ip ospf [vrf <NAME|all>] border-routers [json]
+ show ip ospf [{(1-65535)|vrf <NAME|all>}] graceful-restart helper [detail] [json]
+ show ip ospf mpls-te database [verbose|json]
+ show ip ospf mpls-te database vertex [self-originate|adv-router ADV-ROUTER]
  [verbose|json]
+ show ip ospf mpls-te database edge [A.B.C.D] [verbose|json]
+ show ip ospf mpls-te database subnet [A.B.C.D/M] [verbose|json]
+ show ip ospf database segment-routing <adv-router ADVROUTER|self-originate> [json]
+ show ip ospf [vrf <NAME|all>] summary-address [detail] [json]

*** ospf6d

+ show ipv6 ospf6 summary-address [detail] [json]
+ show ipv6 ospf6 [vrf <NAME|all>] [json]
+ show ipv6 ospf6 [vrf <NAME|all>] database [<detail|dump|internal>] [json]
+ show ipv6 ospf6 [vrf <NAME|all>] database
  <router|network|inter-prefix|inter-router|as-external|group-membership|type-7|link|intra-prefix>
  [json]
+ show ipv6 ospf6 [vrf <NAME|all>] database adv-router A.B.C.D linkstate-id
  A.B.C.D [json]
+ show ipv6 ospf6 [vrf <NAME|all>] database self-originated [json]
+ show ipv6 ospf6 [vrf <NAME|all>] interface [json]
+ show ipv6 ospf6 [vrf <NAME|all>] neighbor [json]
+ show ipv6 ospf6 [vrf <NAME|all>] interface traffic [json]
+ show ipv6 ospf6 zebra [json]
+ show ipv6 ospf6 [vrf <NAME|all>] redistribute [json]
+ show ipv6 ospf6 [vrf <NAME|all>] route
  [<intra-area|inter-area|external-1|external-2|X:X::X:X|X:X::X:X/M|detail|summary>]
  [json]
+ show ipv6 ospf6 [vrf <NAME|all>] route X:X::X:X/M match [detail] [json]
+ show ipv6 ospf6 [vrf <NAME|all>] interface [IFNAME] prefix
  [detail|<X:X::X:X|X:X::X:X/M> [<match|detail>]] [json]
+ show ipv6 ospf6 [vrf <NAME|all>] spf tree [json]
+ show ipv6 ospf6 graceful-restart helper [detail] [json]
*** nhrpd

+ show [ip|ipv6] nhrp cache [json]
+ show [ip|ipv6] nhrp opennhrp [json]
+ show [ip|ipv6] nhrp nhs [json]
+ show dmvpn [json]

*** mgmtd

+ show mgmt datastore-contents [candidate|operation|running] [xpath WORD] [file WORD] json|xml

*** isisd
+ show isis [vrf <NAME|all>] summary [json]
+ show isis [vrf <NAME|all>] interface [detail] [IFNAME] [json]
+ show isis [vrf <NAME|all>] neighbor [detail] [SYSTEMID] [json]
+ show isis [vrf <NAME|all>] database [detail] [LSPID] [json]
+ show isis [vrf <NAME|all>] mpls-te database [detail|json]
+ show isis [vrf <NAME|all>] mpls-te database vertex [WORD] [detail|json]
+ show isis [vrf <NAME|all>] mpls-te database edge [A.B.C.D|X:X::X:X] [detail|json]
+ show isis [vrf <NAME|all>] mpls-te database subnet
[A.B.C.D/M|X:X::X:X/M] [detail|json]

*** filter

+ show <ip|ipv6> access-list [json]
+ show <ip|ipv6> access-list WORD [json]
+ show ip prefix-list [json]
+ show ip prefix-list NAME [json]
+ show ip prefix-list NAME seq NUM [json]
+ show ip prefix-list summary [json]
+ show ip prefix-list summary NAME [json]
+ show ip prefix-list detail [json]
+ show ip prefix-list detail NAME [json]

*** evpn
+ show evpn mac vni (1-16777215) detail [json]
+ show vrf [<NAME$vrf_name|all$vrf_all>] vni [json]

*** bgp

+ show bgp [<ipv4|ipv6>] [<view|vrf> VRF] neighbors [<A.B.C.D|X:X::X:X|WORD>]
  graceful-restart [json]
+ show bgp <afi> <safi> neighbors WORD bestpath-routes [detail] [json] [wide]
+ show [ip] bgp peer-group [json]
+ show bgp as-path-access-list [json]
+ show bgp as-path-access-list WORD [json]
+ show bgp [afi] [safi] [all] alias WORD [wide|json]
+ show ip bgp [all] [wide|json [detail]]
+ show ip bgp A.B.C.D [json]
+ show bgp [all] [wide|json [detail]]
+ show bgp X:X::X:X [json]
+ show bgp router [json]
+ show [ip] bgp [all] summary [wide] [json]
+ show bgp [afi] [safi] [all] [wide|json]
+ show bgp vrfs [<VRFNAME$vrf_name>] [json]
+ show bgp l2vpn evpn route [detail] [type
  <ead|1|macip|2|multicast|3|es|4|prefix|5>] self-originate [json]
+ show bgp vni <all|VNI> [vtep VTEP] [type <ead|1|macip|2|multicast|3>]
  [<detail|json>]
+ show bgp [afi] [safi] [all] summary [json]
+ show bgp [afi] [safi] [all] summary failed [json]
+ show bgp [afi] [safi] [all] summary established [json]
+ show bgp [afi] [safi] [all] summary neighbor [PEER] [json]
+ show bgp [afi] [safi] [all] summary remote-as <internal|external|ASN> [json]
+ show bgp [afi] [safi] [all] summary terse [json]
+ show bgp [afi] [safi] [neighbor [PEER]
  [routes|advertised-routes|received-routes] [<A.B.C.D/M|X:X::X:X/M> | detail]
  [json]
+ show bgp [<view|vrf> VIEWVRFNAME] [afi] [safi] neighbors PEER received
  prefix-filter [json]
+ show bgp [afi] [safi] [all] dampening dampened-paths [wide|json]
+ show bgp [afi] [safi] [all] dampening flap-statistics [wide|json]
+ show bgp [afi] [safi] [all] dampening parameters [json]
+ show bgp [afi] [safi] [all] version (1-4294967295) [wide|json]
+ show [ip] bgp [afi] [safi] [all] cidr-only [wide|json]
+ show [ip] bgp [afi] [safi] [all] prefix-list WORD [wide|json]
+ show [ip] bgp [afi] [safi] [all] access-list WORD [wide|json]
+ show [ip] bgp [afi] [safi] [all] filter-list WORD [wide|json]
+ show [ip] bgp [afi] [safi] [all] route-map WORD [wide|json]
+ show [ip] bgp [afi] [safi] [all] <A.B.C.D/M|X:X::X:X/M> longer-prefixes
  [wide|json]
+ show [ip] bgp [afi] [safi] [all] self-originate [wide|json]
+ show [ip] bgp [afi] [safi] [all] neighbors A.B.C.D
  [advertised-routes|received-routes|filtered-routes] [<A.B.C.D/M|X:X::X:X/M> |
  detail] [json|wide]
+ show [ip] bgp [<view|vrf> VIEWVRFNAME] [afi] [safi] detail [json]
+ show [ip] bgp <ipv4|ipv6> [all] community [wide|json]
+ show [ip] bgp <ipv4|ipv6> [all] community COMMUNITY [wide|json]
+ show [ip] bgp <ipv4|ipv6> [all] community COMMUNITY exact-match [wide|json]
+ show [ip] bgp <ipv4|ipv6> community-list WORD [json]
+ show [ip] bgp <ipv4|ipv6> community-list WORD exact-match [json]
+ show bgp labelpool <chunks|inuse|ledger|requests|summary> [json]
+ show [ip] bgp <ipv4|ipv6> large-community LARGE-COMMUNITY json
+ show [ip] bgp <ipv4|ipv6> large-community-list WORD json
+ show bgp l2vpn evpn route rd <all|RD> mac <MAC> [ip <MAC>] [json]
+ show [ip] bgp [<view|vrf> VIEWVRFNAME] nexthop ipv4 [A.B.C.D] [detail] [json]
+ show [ip] bgp [<view|vrf> VIEWVRFNAME] nexthop ipv6 [X:X::X:X] [detail] [json]
+ show [ip] bgp [<view|vrf> VIEWVRFNAME] nexthop [<A.B.C.D|X:X::X:X>] [detail] [json]
+ show [ip] bgp <view|vrf> all nexthop [json]
+ show [ip] bgp [<view|vrf> VIEWVRFNAME] import-check-table [detail] [json]
+ show bfd [vrf NAME] peers [json]
+ show bfd [vrf NAME] peer <WORD|<A.B.C.D|X:X::X:X> [{multihop|local-address
  <A.B.C.D|X:X::X:X>|interface IFNAME}]> [json]
+ show bfd [vrf NAME] peers brief [json]
+ show bfd static route [json]

*** basic
+ show configuration running [<json|xml> [translate WORD]] [with-defaults]
  DAEMON
+ show yang operational-data XPATH [{format <json|xml>|translate
  TRANSLATOR|with-config}] DAEMON

* Overview :noexport:

*** vtysh topotests (via python, json, or graphviz)

+ [[https://docs.frrouting.org/projects/dev-guide/en/latest/topotests.html#topotest-file-hierarchy][Topotest File Hierarchy]]
+ See [[https://docs.frrouting.org/projects/dev-guide/en/latest/topotests.html#defining-the-topology][Defining The Topology]] for graphviz

Defining and running a new "topotest" in the =frr= routing suite requres
specifying a topology using: python, json or graphviz.

+ The topotest tooling may also function to convert between topologies
+ While also /providing a standard JSON format for specifying a topology./

This is nice because automating network configuration (esp. for firewalls; esp
in a fairly green-field network) requires enumerating paths through the network.

+ =traceroute= doesn't really work, neither do =netcat= or =nmap=. They provide
  partial validation of the possibility of a path, but you have to be:
  - in the right place, sending packets through the correct port
  - at the right time (on a device with the right session states)
+ But the device itself already knows it's configuration/state. Why can't I just
  ask it? You can get this from the FRR device's configuration, but that only
  applies to specific devices.
+ What I would like is to specify the network in data, particularly the /links/
  and /routes/. Then collect that data, merge it into a topology, define some
  devices/interfaces as being a special type
  - Even finding a data structure that LOOKS like this has been impossible.
  - I should be able to enumerate over the structure and specify possible paths
    between two endpoints (including the hops in between)
+ Spec out a list of hosts and services -- should look like your typical ansible
  =hosts.yml= where those roles would be services -- then combine pairs of hsots
  with the routes (enumerated from the topology), qualifying a list of services
  - This should give you a list of paths over which the traffic should flow (or
    should not flow).
+ From here, you find the closests/farthest hops in common (between all the
  paths or some of the paths) and any edge routers/firewalls. These are the
  points where the least number of firewall rules can make the most difference.
+ Assembling the topology data from actual router state allows you to determine
  dynamically, some potential paths which should be tested by nmap (which may
  not be covered by a firewall.)
  - This helps close gaps where configuration has drifted from the
    expected/assumed implementation of FW policy
+ Assembling the topology data ahead-of-time (during network bootstrap) allows
  you to specify a sensible scheme for your firewall rules, so they can be
  sequenced (iptables, nftables sequence number) and assigned a UUID
  (generated from the configuration, stored in the fw rule description /and/ in
  a hash)
  - look at your Azure/AWS/GCP GUI. I bet you $1,000,000 there's multiple UUID
    beside every object. Different ball-park, but basically the same thing
    (getting UUID consistency across a large network is difficult ... for a
    small network should be simple)

There are other ways to do this: nautobot, YANG, online services proprietary
methods (almost never universal enough to extend their APIs & libs to linux
boxes) ... however, none of these are affordable (waste of time for me to invest
in learning) and none typically function on a dynamic/unstable/adhoc network.
